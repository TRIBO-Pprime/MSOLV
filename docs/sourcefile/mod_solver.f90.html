<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="MSOLV-fortran – A modern Fortran API for Sparse Direct Solvers, as part of">
    
    <meta name="author" content="Arthur Francisco - Noël Brunetière" >
    <link rel="icon" href="../favicon.png">

    <title>mod_solver.f90 &ndash; MSOLV-fortran</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">MSOLV-fortran </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/test_solvers.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/test_solvers.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>mod_solver.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="14.0% of total for source files.">516 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/mod_solver.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">mod_solver.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/solver.html">solver</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/mod_solver.f90.html#src">mod_solver.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.36.0 (20140111.2315)
 -->
<!-- Title: sourcefile~~mod_solver.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemod_solverf90EfferentGraph" width="374pt" height="180pt"
 viewBox="0.00 0.00 374.00 179.94" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~mod_solver.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 175.945)">
<title>sourcefile~~mod_solver.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-175.945 370,-175.945 370,4 -4,4"/>
<!-- sourcefile~mod_solver.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node1" class="node"><title>sourcefile~mod_solver.f90</title>
<polygon fill="none" stroke="black" points="366,-108 280,-108 280,-84 366,-84 366,-108"/>
<text text-anchor="middle" x="323" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50">mod_solver.f90</text>
</g>
<!-- sourcefile~mod_data_arch.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node2" class="node"><title>sourcefile~mod_data_arch.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/mod_data_arch.f90.html" xlink:title="mod_data_arch.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-170 7.10543e-15,-170 7.10543e-15,-146 106,-146 106,-170"/>
<text text-anchor="middle" x="53" y="-155.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mod_data_arch.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mod_solver.f90&#45;&gt;sourcefile~mod_data_arch.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge1" class="edge"><title>sourcefile~mod_solver.f90&#45;&gt;sourcefile~mod_data_arch.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M311.908,-108.144C298.329,-123.43 272.557,-148.908 244,-159 203.347,-173.367 154.675,-172.802 116.77,-168.808"/>
<polygon fill="#ff0000" stroke="#ff0000" points="116.718,-165.278 106.381,-167.6 115.91,-172.231 116.718,-165.278"/>
</g>
<!-- sourcefile~mod_num_par.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node3" class="node"><title>sourcefile~mod_num_par.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/mod_num_par.f90.html" xlink:title="mod_num_par.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="243,-150 143,-150 143,-126 243,-126 243,-150"/>
<text text-anchor="middle" x="193" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mod_num_par.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mod_solver.f90&#45;&gt;sourcefile~mod_num_par.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge2" class="edge"><title>sourcefile~mod_solver.f90&#45;&gt;sourcefile~mod_num_par.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M285.32,-108.036C271.261,-112.649 255.036,-117.972 240.199,-122.841"/>
<polygon fill="#ff0000" stroke="#ff0000" points="239.095,-119.519 230.685,-125.963 241.278,-126.171 239.095,-119.519"/>
</g>
<!-- sourcefile~umfpack.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node4" class="node"><title>sourcefile~umfpack.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/umfpack.f90.html" xlink:title="umfpack.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="228.5,-108 157.5,-108 157.5,-84 228.5,-84 228.5,-108"/>
<text text-anchor="middle" x="193" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">umfpack.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mod_solver.f90&#45;&gt;sourcefile~umfpack.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge3" class="edge"><title>sourcefile~mod_solver.f90&#45;&gt;sourcefile~umfpack.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M279.733,-96C266.633,-96 252.153,-96 238.882,-96"/>
<polygon fill="#ff0000" stroke="#ff0000" points="238.546,-92.5001 228.546,-96 238.546,-99.5001 238.546,-92.5001"/>
</g>
<!-- sourcefile~dmumps_struc.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node5" class="node"><title>sourcefile~dmumps_struc.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/dmumps_struc.f90.html" xlink:title="dmumps_struc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="243.5,-66 142.5,-66 142.5,-42 243.5,-42 243.5,-66"/>
<text text-anchor="middle" x="193" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dmumps_struc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mod_solver.f90&#45;&gt;sourcefile~dmumps_struc.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge4" class="edge"><title>sourcefile~mod_solver.f90&#45;&gt;sourcefile~dmumps_struc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M285.32,-83.9645C271.261,-79.3513 255.036,-74.0276 240.199,-69.1589"/>
<polygon fill="#ff0000" stroke="#ff0000" points="241.278,-65.8295 230.685,-66.0373 239.095,-72.4806 241.278,-65.8295"/>
</g>
<!-- sourcefile~superlu.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_node6" class="node"><title>sourcefile~superlu.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/superlu.f90.html" xlink:title="superlu.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="226,-24 160,-24 160,-0 226,-0 226,-24"/>
<text text-anchor="middle" x="193" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">superlu.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mod_solver.f90&#45;&gt;sourcefile~superlu.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge5" class="edge"><title>sourcefile~mod_solver.f90&#45;&gt;sourcefile~superlu.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M309.321,-83.8569C294.545,-70.1762 268.955,-47.9089 244,-33 241.212,-31.3341 238.267,-29.7358 235.258,-28.2172"/>
<polygon fill="#ff0000" stroke="#ff0000" points="236.671,-25.014 226.134,-23.9122 233.684,-31.3447 236.671,-25.014"/>
</g>
<!-- sourcefile~mod_num_par.f90&#45;&gt;sourcefile~mod_data_arch.f90 -->
<g id="sourcefile~~mod_solver.f90~~EfferentGraph_edge6" class="edge"><title>sourcefile~mod_num_par.f90&#45;&gt;sourcefile~mod_data_arch.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M142.958,-145.108C134.29,-146.364 125.161,-147.687 116.189,-148.987"/>
<polygon fill="#cbff00" stroke="#cbff00" points="115.551,-145.543 106.157,-150.441 116.555,-152.471 115.551,-145.543"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.36.0 (20140111.2315)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="189pt" height="32pt"
 viewBox="0.00 0.00 189.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 185,-28 185,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66.25,-24 -0.25,-24 -0.25,-0 66.25,-0 66.25,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="181.25,-24 84.75,-24 84.75,-0 181.25,-0 181.25,-24"/>
<text text-anchor="middle" x="133" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.36.0 (20140111.2315)
 -->
<!-- Title: sourcefile~~mod_solver.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemod_solverf90AfferentGraph" width="184pt" height="32pt"
 viewBox="0.00 0.00 184.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~mod_solver.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~mod_solver.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 180,-28 180,4 -4,4"/>
<!-- sourcefile~mod_solver.f90 -->
<g id="sourcefile~~mod_solver.f90~~AfferentGraph_node1" class="node"><title>sourcefile~mod_solver.f90</title>
<polygon fill="none" stroke="black" points="86,-24 0,-24 0,-0 86,-0 86,-24"/>
<text text-anchor="middle" x="43" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">mod_solver.f90</text>
</g>
<!-- sourcefile~prg.f90 -->
<g id="sourcefile~~mod_solver.f90~~AfferentGraph_node2" class="node"><title>sourcefile~prg.f90</title>
<g id="a_sourcefile~~mod_solver.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/prg.f90.html" xlink:title="prg.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="176,-24 122,-24 122,-0 176,-0 176,-24"/>
<text text-anchor="middle" x="149" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">prg.f90</text>
</a>
</g>
</g>
<!-- sourcefile~prg.f90&#45;&gt;sourcefile~mod_solver.f90 -->
<g id="sourcefile~~mod_solver.f90~~AfferentGraph_edge1" class="edge"><title>sourcefile~prg.f90&#45;&gt;sourcefile~mod_solver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M121.756,-12C113.887,-12 104.964,-12 96.04,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="96.0198,-8.5001 86.0197,-12 96.0197,-15.5001 96.0198,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.36.0 (20140111.2315)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="189pt" height="32pt"
 viewBox="0.00 0.00 189.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 185,-28 185,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66.25,-24 -0.25,-24 -0.25,-0 66.25,-0 66.25,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="181.25,-24 84.75,-24 84.75,-0 181.25,-0 181.25,-24"/>
<text text-anchor="middle" x="133" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/solver.html">solver</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/mod_solver.f90.html#src">mod_solver.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!&lt; author: Arthur Francisco</span>
<a name="ln-2"></a><span class="c">!  version: 1.0.0</span>
<a name="ln-3"></a><span class="c">!  date: july, 12 2018</span>
<a name="ln-4"></a><span class="c">!</span>
<a name="ln-5"></a><span class="c">!  &lt;span style=&quot;color: #337ab7; font-family: cabin; font-size: 1.5em;&quot;&gt;</span>
<a name="ln-6"></a><span class="c">!     **Api for different sparse matrix solvers**</span>
<a name="ln-7"></a><span class="c">!  &lt;/span&gt;</span>
<a name="ln-8"></a>
<a name="ln-9"></a><span class="k">module </span><span class="n">solver</span>
<a name="ln-10"></a><span class="k">use </span><span class="nb">iso_c_binding</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="kt">C_PTR</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="nb">C_ASSOCIATED</span>
<a name="ln-11"></a><span class="k">use </span><span class="n">data_arch</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">I4</span><span class="p">,</span> <span class="n">I8</span><span class="p">,</span> <span class="n">R8</span><span class="p">,</span> <span class="n">EPS_R8</span><span class="p">,</span> <span class="n">HIG_R8</span>
<a name="ln-12"></a><span class="k">use </span><span class="n">num_param</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">OPU</span><span class="p">,</span> <span class="n">SOLV_MESS</span><span class="p">,</span> <span class="n">NO_MESS</span><span class="p">,</span> <span class="n">PRINT_MESS</span>
<a name="ln-13"></a><span class="c">!-------------------------------------------------</span>
<a name="ln-14"></a><span class="k">use </span><span class="n">hsl_ma48_double</span>
<a name="ln-15"></a><span class="c">!-------------------------------------------------</span>
<a name="ln-16"></a><span class="k">use </span><span class="n">sulu_wrapper</span><span class="p">,</span>  <span class="n">MAT_SULU</span> <span class="o">=&gt;</span> <span class="n">SULU_ENV</span>      <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-17"></a>           <span class="n">SULU_SAMEPATTERN</span> <span class="o">=&gt;</span> <span class="n">SAMEPATTERN</span>   <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-18"></a>              <span class="n">SULU_FACTORED</span> <span class="o">=&gt;</span> <span class="n">FACTORED</span>      <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-19"></a>                <span class="n">SULU_DOFACT</span> <span class="o">=&gt;</span> <span class="n">DOFACT</span>
<a name="ln-20"></a><span class="c">!-------------------------------------------------</span>
<a name="ln-21"></a><span class="k">use </span><span class="n">mumps_wrapper</span><span class="p">,</span> <span class="n">MAT_MUMP</span> <span class="o">=&gt;</span> <span class="n">DMUMPS_STRUC</span>
<a name="ln-22"></a><span class="c">!-------------------------------------------------</span>
<a name="ln-23"></a><span class="k">use </span><span class="n">mumfpack</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">UMFPACK_CONTROL</span>               <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-24"></a>                     <span class="n">UMFPACK_STATUS</span>                <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-25"></a>                     <span class="n">UMFPACK_INFO</span>                  <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-26"></a>                     <span class="n">UMFPACK_PRL</span>                   <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-27"></a>                     <span class="n">UMFPACK_IRSTEP</span>                <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-28"></a>                     <span class="n">UMFPACK_NUMERIC_SIZE_ESTIMATE</span> <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-29"></a>                     <span class="n">UMFPACK_PEAK_MEMORY_ESTIMATE</span>  <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-30"></a>                     <span class="n">UMFPACK_SIZE_OF_UNIT</span>          <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-31"></a>                     <span class="n">UMFPACK_DI_DEFAULTS</span>           <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-32"></a>                     <span class="n">UMFPACK_DI_REPORT_CONTROL</span>     <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-33"></a>                     <span class="n">UMFPACK_DI_FREE_NUMERIC</span>       <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-34"></a>                     <span class="n">UMFPACK_DI_FREE_SYMBOLIC</span>      <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-35"></a>                     <span class="n">UMFPACK_DI_REPORT_INFO</span>        <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-36"></a>                     <span class="n">S_UMFPACK_DI_SYMBOLIC</span>         <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-37"></a>                     <span class="n">S_UMFPACK_DI_NUMERIC</span>          <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-38"></a>                     <span class="n">S_UMFPACK_DI_SOLVE</span>            <span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-39"></a>                     <span class="n">UMFPACK_A</span>
<a name="ln-40"></a><span class="c">!-------------------------------------------------</span>
<a name="ln-41"></a><span class="k">implicit none</span>
<a name="ln-42"></a>
<a name="ln-43"></a><span class="k">type </span><span class="n">MAT_MA48</span>
<a name="ln-44"></a><span class="c">!! &lt;span style=&quot;color:green&quot;&gt;All the stuff needed by *HSL_MA48*&lt;/span&gt;</span>
<a name="ln-45"></a>   <span class="k">type</span><span class="p">(</span><span class="n">ZD11_TYPE</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">zmat</span>
<a name="ln-46"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MA48_CONTROL</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ctrl</span>
<a name="ln-47"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MA48_AINFO</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">ainf</span>
<a name="ln-48"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MA48_FINFO</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">finf</span>
<a name="ln-49"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MA48_SINFO</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">sinf</span>
<a name="ln-50"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MA48_FACTORS</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fact</span>
<a name="ln-51"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">fast</span>
<a name="ln-52"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="kd">::</span> <span class="n">resid</span>
<a name="ln-53"></a><span class="n">endtype</span> <span class="n">MAT_MA48</span>
<a name="ln-54"></a>
<a name="ln-55"></a><span class="k">type </span><span class="n">MAT_UMFP</span>
<a name="ln-56"></a><span class="c">!! &lt;span style=&quot;color:green&quot;&gt;All the stuff needed by *UMFPACK*&lt;/span&gt;</span>
<a name="ln-57"></a>   <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c_symbolic</span>                             
<a name="ln-58"></a>   <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c_numeric</span>                                    
<a name="ln-59"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">UMFPACK_CONTROL</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c_control</span>  
<a name="ln-60"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">UMFPACK_INFO</span>   <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c_info</span>     
<a name="ln-61"></a><span class="n">endtype</span> <span class="n">MAT_UMFP</span>
<a name="ln-62"></a>
<a name="ln-63"></a><span class="k">type </span><span class="n">MAT_SOLV</span>
<a name="ln-64"></a><span class="c">!! &lt;span style=&quot;color:green&quot;&gt;MUSST high level system type&lt;/span&gt;</span>
<a name="ln-65"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">slv_t</span>                             <span class="c">!! *solver type*</span>
<a name="ln-66"></a>   <span class="kt">logical</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">first</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>                    <span class="c">!! *analysis of the system to be done?*</span>
<a name="ln-67"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nn</span>                                <span class="c">!! *number of nodes*</span>
<a name="ln-68"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ne</span>                                <span class="c">!! *number of elements*</span>
<a name="ln-69"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nt</span>                                <span class="c">!! *number of **a priori** non-zero terms in the matrix*</span>
<a name="ln-70"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>                                <span class="c">!! *number of non-zero terms in the matrix*</span>
<a name="ln-71"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvar</span>                              <span class="c">!! *eltvar length ( if 4-nodes elt -&gt; 2 lines X number of elemental matrices)*</span>
<a name="ln-72"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">code</span>                              <span class="c">!! *error code*   [not used yet]</span>
<a name="ln-73"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">error</span>                             <span class="c">!! *error value*  [not used yet]</span>
<a name="ln-74"></a>   <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mess</span>                           <span class="c">!! *message*      [not used yet]</span>
<a name="ln-75"></a>   <span class="c">!.....................................................</span>
<a name="ln-76"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_MUMP</span><span class="p">)</span> <span class="kd">::</span> <span class="n">matmump</span>                             <span class="c">!! *matrices for mumps solver*</span>
<a name="ln-77"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_MA48</span><span class="p">)</span> <span class="kd">::</span> <span class="n">matma48</span>                             <span class="c">!! *matrices for ma48 solver*</span>
<a name="ln-78"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_SULU</span><span class="p">)</span> <span class="kd">::</span> <span class="n">matsulu</span>                             <span class="c">!! *matrices for SuperLu solver*</span>
<a name="ln-79"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_UMFP</span><span class="p">)</span> <span class="kd">::</span> <span class="n">matumfp</span>                             <span class="c">!! *matrices for Umfpack solver*</span>
<a name="ln-80"></a>   <span class="c">!.....................................................</span>
<a name="ln-81"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">eltvar</span> <span class="c">!! *rows in assembled matrix*</span>
<a name="ln-82"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">eltptr</span> <span class="c">!! *element rows pointer*</span>
<a name="ln-83"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span>    <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">a_elt</span>  <span class="c">!! *unassembled rigidity matrix*</span>
<a name="ln-84"></a>   <span class="c">!.....................................................</span>
<a name="ln-85"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">irow</span>   <span class="c">!! *line number*</span>
<a name="ln-86"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">jcol</span>   <span class="c">!! *column number*</span>
<a name="ln-87"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">jptr</span>   <span class="c">!! *line pointer*</span>
<a name="ln-88"></a>   <span class="c">!.....................................................</span>
<a name="ln-89"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span>    <span class="kd">::</span> <span class="n">b</span>      <span class="c">!! *right hand side vector*</span>
<a name="ln-90"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span>    <span class="kd">::</span> <span class="n">x</span>      <span class="c">!! *unknwon vector*</span>
<a name="ln-91"></a><span class="n">endtype</span> <span class="n">MAT_SOLV</span>
<a name="ln-92"></a>  
<a name="ln-93"></a>
<a name="ln-94"></a><span class="c">!&lt; &lt;span style=&quot;color:green&quot;&gt;MUSST multiscale high level solver type&lt;/span&gt;</span>
<a name="ln-95"></a><span class="c">!  @note ```MS_MAT_SOLV``` is needed by MUSST, but it is useless for the present module</span>
<a name="ln-96"></a><span class="c">! </span>
<a name="ln-97"></a><span class="k">type </span><span class="n">MS_MAT_SOLV</span>
<a name="ln-98"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ts_mat</span>                                       <span class="c">!! *top-scale solver type matrices*</span>
<a name="ln-99"></a>   <span class="k">type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span>   <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">bs_mat</span>          <span class="c">!! *bottom-scale solver type matrices (table)*</span>
<a name="ln-100"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">ass_loc_in_mat</span>  <span class="c">!! *table for assembly location (for parallel computation)*</span>
<a name="ln-101"></a><span class="n">endtype</span> <span class="n">ms_mat_solv</span>
<a name="ln-102"></a>
<a name="ln-103"></a>
<a name="ln-104"></a><span class="c">! Solver types</span>
<a name="ln-105"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">MA48</span>  <span class="o">=</span> <span class="mi">0</span> <span class="c">!! *code for     Ma48 solver type*</span>
<a name="ln-106"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">SULU</span>  <span class="o">=</span> <span class="mi">1</span> <span class="c">!! *code for SUPER LU solver type*</span>
<a name="ln-107"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">MUMP</span>  <span class="o">=</span> <span class="mi">2</span> <span class="c">!! *code for    MUMPS solver type*</span>
<a name="ln-108"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">UMFP</span>  <span class="o">=</span> <span class="mi">3</span> <span class="c">!! *code for  UMFPACK solver type*</span>
<a name="ln-109"></a>
<a name="ln-110"></a><span class="c">! What solver to use for bottom- or top- scale grids</span>
<a name="ln-111"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">SOLVER_BS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c">!! *solver used for bottom scale grids* [not used by the present module]</span>
<a name="ln-112"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">SOLVER_TS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c">!! *solver used for top scale grids* [not used by the present module]</span>
<a name="ln-113"></a>
<a name="ln-114"></a><span class="k">contains</span>
<a name="ln-115"></a>  
<a name="ln-116"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-117"></a>   <span class="c">!&lt; @note General hat subroutine that handles the resolution steps:      &lt;br/&gt;</span>
<a name="ln-118"></a>   <span class="c">!  * ```ini``` solver initialization                                    &lt;br/&gt;</span>
<a name="ln-119"></a>   <span class="c">!  * ```ana``` solver analyzis when it&#39;s proposed by the solver         &lt;br/&gt;</span>
<a name="ln-120"></a>   <span class="c">!  * ```fac``` solver factorization                                     &lt;br/&gt;</span>
<a name="ln-121"></a>   <span class="c">!  * ```sol``` solver solution                                          &lt;br/&gt;</span>
<a name="ln-122"></a>   <span class="c">!  * ```fre``` solver memory release when it&#39;s proposed by the solver   &lt;br/&gt;</span>
<a name="ln-123"></a>   <span class="c">!  * ```end``` solver end</span>
<a name="ln-124"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-125"></a>   <span class="k">subroutine </span><span class="n">solve_syst</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
<a name="ln-126"></a>   <span class="k">implicit none</span>
<a name="ln-127"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-128"></a>   <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">step</span>  <span class="c">!! *&#39;ini&#39;=initialize, &#39;ana&#39;=analyze, &#39;fac&#39;=factorize, &#39;sol&#39;=solve, &#39;fre&#39;=free memory, &#39;end&#39;=close solver*</span>
<a name="ln-129"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;ini&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">init_solver</span><span class="p">(</span>     <span class="n">mat</span><span class="p">)</span> <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-130"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;ana&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">analyse_solver</span><span class="p">(</span>  <span class="n">mat</span><span class="p">)</span> <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-131"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;fac&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">factorize_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-132"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;sol&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">solution_solver</span><span class="p">(</span> <span class="n">mat</span><span class="p">)</span> <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-133"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">freefact_solver</span><span class="p">(</span> <span class="n">mat</span><span class="p">)</span> <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-134"></a>      <span class="k">if</span> <span class="p">(</span> <span class="nb">index</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span><span class="o">/=</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="p">;</span> <span class="k">call </span><span class="n">close_solver</span><span class="p">(</span> <span class="n">mat</span><span class="p">)</span>    <span class="p">;</span> <span class="k">return</span> <span class="p">;</span> <span class="n">endif</span>
<a name="ln-135"></a>      <span class="k">stop</span> <span class="s1">&#39;Bad step chosen in SOLVE_SYST&#39;</span>
<a name="ln-136"></a>   <span class="k">return</span>
<a name="ln-137"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">solve_syst</span>
<a name="ln-138"></a>
<a name="ln-139"></a>
<a name="ln-140"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-141"></a>   <span class="c">!&gt; @note Subroutine to initialize the matrices of the solver</span>
<a name="ln-142"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-143"></a>   <span class="k">subroutine </span><span class="n">init_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-144"></a>   <span class="k">implicit none</span>
<a name="ln-145"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-146"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ierr</span>
<a name="ln-147"></a>
<a name="ln-148"></a>      <span class="c">! allocation of the system vectors: rhs and unknown</span>
<a name="ln-149"></a>      <span class="k">allocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">),</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-150"></a>      <span class="n">mat</span><span class="p">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">HIG_R8</span>
<a name="ln-151"></a>      <span class="n">mat</span><span class="p">%</span><span class="n">x</span> <span class="o">=</span> <span class="n">HIG_R8</span>
<a name="ln-152"></a>
<a name="ln-153"></a>      <span class="c">! check solver type</span>
<a name="ln-154"></a>      <span class="k">select case</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-155"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-156"></a>            <span class="k">call </span><span class="n">ma48_initialize</span><span class="p">(</span><span class="n">factors</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fact</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-157"></a>                                 <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">)</span>
<a name="ln-158"></a>            <span class="k">select case</span><span class="p">(</span><span class="n">SOLV_MESS</span><span class="p">)</span>
<a name="ln-159"></a>               <span class="k">case</span><span class="p">(</span><span class="n">NO_MESS</span><span class="p">)</span>
<a name="ln-160"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">%</span><span class="n">wp</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-161"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">%</span><span class="n">mp</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-162"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">%</span><span class="n">ldiag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-163"></a>               <span class="k">case</span><span class="p">(</span><span class="n">PRINT_MESS</span><span class="p">:)</span>
<a name="ln-164"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">%</span><span class="n">ldiag</span> <span class="o">=</span> <span class="o">+</span><span class="mi">2</span>
<a name="ln-165"></a>            <span class="n">endselect</span>
<a name="ln-166"></a>
<a name="ln-167"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-168"></a>            <span class="k">call </span><span class="n">mpi_init</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-169"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI_COMM_WORLD</span>
<a name="ln-170"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">job</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>               <span class="c">! initialisation</span>
<a name="ln-171"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">sym</span>  <span class="o">=</span>  <span class="mi">0</span>               <span class="c">! no symetry</span>
<a name="ln-172"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">par</span>  <span class="o">=</span>  <span class="mi">1</span>               <span class="c">! MPI, host working</span>
<a name="ln-173"></a>            <span class="k">call </span><span class="n">dmumps</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">)</span>
<a name="ln-174"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">icntl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span>  <span class="mi">1</span>           <span class="c">! Specify element entry : elemental matrices</span>
<a name="ln-175"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-176"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span><span class="s1">&#39;(a,a,i6,a,i9)&#39;</span><span class="p">)</span> <span class="s1">&#39; error return: &#39;</span><span class="p">,</span>                              <span class="p">&amp;</span>
<a name="ln-177"></a>                                          <span class="s1">&#39;  mumps_par%infog(1)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-178"></a>                                          <span class="s1">&#39;  mumps_par%infog(2)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-179"></a>               <span class="k">call </span><span class="n">mpi_finalize</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-180"></a>               <span class="k">stop</span> <span class="s1">&#39;MUMP error, INIT_SOLVER&#39;</span>
<a name="ln-181"></a>            <span class="n">endif</span>
<a name="ln-182"></a>            <span class="k">select case</span><span class="p">(</span><span class="n">SOLV_MESS</span><span class="p">)</span>
<a name="ln-183"></a>               <span class="k">case</span><span class="p">(</span><span class="n">NO_MESS</span><span class="p">)</span>
<a name="ln-184"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">icntl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span>  <span class="mi">1</span> <span class="c">! error output only</span>
<a name="ln-185"></a>               <span class="k">case</span><span class="p">(</span><span class="n">PRINT_MESS</span><span class="p">:)</span>
<a name="ln-186"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">icntl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span>  <span class="mi">3</span> <span class="c">! all error output</span>
<a name="ln-187"></a>            <span class="n">endselect</span>
<a name="ln-188"></a>
<a name="ln-189"></a>         <span class="k">case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-190"></a>            <span class="k">call </span><span class="n">init_superlu</span><span class="p">(</span><span class="n">sulu</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">)</span>
<a name="ln-191"></a>            <span class="k">select case</span><span class="p">(</span><span class="n">SOLV_MESS</span><span class="p">)</span>
<a name="ln-192"></a>               <span class="k">case</span><span class="p">(</span><span class="n">NO_MESS</span><span class="p">)</span>
<a name="ln-193"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="k">options</span><span class="p">%</span><span class="n">PrintStat</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-194"></a>               <span class="k">case</span><span class="p">(</span><span class="n">PRINT_MESS</span><span class="p">:)</span>
<a name="ln-195"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="k">options</span><span class="p">%</span><span class="n">PrintStat</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-196"></a>            <span class="n">endselect</span>
<a name="ln-197"></a>
<a name="ln-198"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-199"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span> <span class="o">=</span> <span class="nb">C_NULL_PTR</span>
<a name="ln-200"></a><span class="nb">            </span><span class="k">call </span><span class="n">umfpack_di_defaults</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">)</span>
<a name="ln-201"></a>            <span class="k">select case</span><span class="p">(</span><span class="n">SOLV_MESS</span><span class="p">)</span>
<a name="ln-202"></a>               <span class="k">case</span><span class="p">(</span><span class="n">NO_MESS</span><span class="p">)</span>
<a name="ln-203"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">(</span><span class="n">UMFPACK_PRL</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-204"></a>               <span class="k">case</span><span class="p">(</span><span class="n">PRINT_MESS</span><span class="p">:)</span>
<a name="ln-205"></a>                  <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">(</span><span class="n">UMFPACK_PRL</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-206"></a>            <span class="n">endselect</span>
<a name="ln-207"></a>            <span class="k">call </span><span class="n">umfpack_di_report_control</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">)</span>
<a name="ln-208"></a>
<a name="ln-209"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-210"></a>            <span class="k">stop</span> <span class="s1">&#39;Unknown solver type, INIT_SOLVER&#39;</span>
<a name="ln-211"></a>
<a name="ln-212"></a>      <span class="n">endselect</span>
<a name="ln-213"></a>
<a name="ln-214"></a>   <span class="k">return</span>
<a name="ln-215"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">init_solver</span>
<a name="ln-216"></a>
<a name="ln-217"></a>
<a name="ln-218"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-219"></a>   <span class="c">!&gt; @note Subroutine to analyse, factorize (symbolic) the matrix of the system</span>
<a name="ln-220"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-221"></a>   <span class="k">subroutine </span><span class="n">analyse_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-222"></a>   <span class="k">implicit none</span>
<a name="ln-223"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-224"></a>
<a name="ln-225"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-226"></a>
<a name="ln-227"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-228"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">row</span> <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span>
<a name="ln-229"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">col</span> <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">jcol</span>
<a name="ln-230"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">val</span> <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span>
<a name="ln-231"></a>
<a name="ln-232"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">n</span>   <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span>
<a name="ln-233"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">m</span>   <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span>
<a name="ln-234"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">ne</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nz</span>
<a name="ln-235"></a>
<a name="ln-236"></a>            <span class="k">call </span><span class="n">ma48_analyse</span><span class="p">(</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-237"></a>                             <span class="n">factors</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fact</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-238"></a>                             <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-239"></a>                               <span class="n">ainfo</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ainf</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-240"></a>                               <span class="n">finfo</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">finf</span><span class="p">)</span>
<a name="ln-241"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ainf</span><span class="p">%</span><span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-242"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Failure of ma48_analyse with ainfop%flag = &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ainf</span><span class="p">%</span><span class="n">flag</span>
<a name="ln-243"></a>               <span class="k">stop</span>
<a name="ln-244"></a><span class="k">            </span><span class="n">endif</span>
<a name="ln-245"></a>
<a name="ln-246"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-247"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">eltptr</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltptr</span>
<a name="ln-248"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">eltvar</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltvar</span>
<a name="ln-249"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">a_elt</span>    <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span>
<a name="ln-250"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">rhs</span>      <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span>
<a name="ln-251"></a>
<a name="ln-252"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">n</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span>
<a name="ln-253"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">nelt</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">ne</span>
<a name="ln-254"></a>
<a name="ln-255"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">job</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! performs the analysis</span>
<a name="ln-256"></a>
<a name="ln-257"></a>            <span class="k">call </span><span class="n">dmumps</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">)</span>
<a name="ln-258"></a>
<a name="ln-259"></a>         <span class="k">case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-260"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">irow</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span>
<a name="ln-261"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">jptr</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span>
<a name="ln-262"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">a_elt</span>  <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span>
<a name="ln-263"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">b</span>      <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span>
<a name="ln-264"></a>
<a name="ln-265"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">n</span>     <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span>
<a name="ln-266"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">nz</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nz</span>
<a name="ln-267"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">nrhs</span>  <span class="o">=</span> <span class="mi">1</span>
<a name="ln-268"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">first</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-269"></a>
<a name="ln-270"></a>            <span class="k">call </span><span class="n">prep_superlu</span><span class="p">(</span><span class="n">sulu</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">)</span>
<a name="ln-271"></a>
<a name="ln-272"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-273"></a>            <span class="k">call </span><span class="n">s_umfpack_di_symbolic</span><span class="p">(</span><span class="n">n_row</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">,</span>                  <span class="p">&amp;</span>
<a name="ln-274"></a>                                       <span class="n">n_col</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">,</span>                  <span class="p">&amp;</span>
<a name="ln-275"></a>                                       <span class="n">Ap</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">,</span>                <span class="p">&amp;</span>
<a name="ln-276"></a>                                       <span class="n">Ai</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">,</span>                <span class="p">&amp;</span>
<a name="ln-277"></a>                                       <span class="n">Ax</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span><span class="p">,</span>               <span class="p">&amp;</span>
<a name="ln-278"></a>                                       <span class="n">Symbolic</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_symbolic</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-279"></a>                                       <span class="n">Control</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-280"></a>                                       <span class="n">Info</span>     <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">)</span>
<a name="ln-281"></a>
<a name="ln-282"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-283"></a>            <span class="k">stop</span> <span class="s1">&#39;ANALYSE_SOLVER : unknown solver type&#39;</span>
<a name="ln-284"></a>
<a name="ln-285"></a>      <span class="n">endselect</span>
<a name="ln-286"></a>
<a name="ln-287"></a>   <span class="k">return</span>
<a name="ln-288"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">analyse_solver</span>
<a name="ln-289"></a>
<a name="ln-290"></a>
<a name="ln-291"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-292"></a>   <span class="c">!&gt; @note Subroutine to factorize the matrix of the system</span>
<a name="ln-293"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-294"></a>   <span class="k">subroutine </span><span class="n">factorize_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-295"></a>   <span class="k">implicit none</span>
<a name="ln-296"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-297"></a>
<a name="ln-298"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-299"></a>
<a name="ln-300"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-301"></a>            <span class="k">call </span><span class="n">ma48_factorize</span><span class="p">(</span> <span class="n">matrix</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-302"></a>                                 <span class="n">factors</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fact</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-303"></a>                                 <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-304"></a>                                 <span class="n">finfo</span>   <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">finf</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-305"></a>                                 <span class="n">fast</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fast</span><span class="p">)</span>
<a name="ln-306"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">finf</span><span class="p">%</span><span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-307"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Failure of ma48_factorize with finfo%flag = &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">finf</span><span class="p">%</span><span class="n">flag</span>
<a name="ln-308"></a>               <span class="k">stop</span>
<a name="ln-309"></a><span class="k">            </span><span class="n">endif</span>
<a name="ln-310"></a>
<a name="ln-311"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-312"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">job</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-313"></a>            <span class="k">call </span><span class="n">dmumps</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">)</span>
<a name="ln-314"></a>
<a name="ln-315"></a>         <span class="k">case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-316"></a>            <span class="c">! Just factorize once, in the case that the matrix doesn&#39;t change much</span>
<a name="ln-317"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">first</span><span class="p">)</span> <span class="k">call </span><span class="n">fact_superlu</span><span class="p">(</span> <span class="n">sulu</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-318"></a>                                                      <span class="n">verbose</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="k">options</span><span class="p">%</span><span class="n">PrintStat</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-319"></a>
<a name="ln-320"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-321"></a>            <span class="k">call </span><span class="n">umfpack_di_free_numeric</span><span class="p">(</span><span class="n">Numeric</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">)</span> <span class="c">! first release memory</span>
<a name="ln-322"></a>            <span class="k">call </span><span class="n">s_umfpack_di_numeric</span><span class="p">(</span><span class="n">Ap</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">,</span>                 <span class="p">&amp;</span>
<a name="ln-323"></a>                                      <span class="n">Ai</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">,</span>                 <span class="p">&amp;</span>
<a name="ln-324"></a>                                      <span class="n">Ax</span>       <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span><span class="p">,</span>                <span class="p">&amp;</span>
<a name="ln-325"></a>                                      <span class="n">Symbolic</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_symbolic</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-326"></a>                                      <span class="n">Numeric</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">,</span>    <span class="p">&amp;</span>
<a name="ln-327"></a>                                      <span class="n">Control</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">,</span>    <span class="p">&amp;</span>
<a name="ln-328"></a>                                      <span class="n">Info</span>     <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">)</span>
<a name="ln-329"></a>
<a name="ln-330"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-331"></a>            <span class="k">stop</span> <span class="s1">&#39;Unknown solver type, FACTORIZE_SOLVER&#39;</span>
<a name="ln-332"></a>
<a name="ln-333"></a>      <span class="n">endselect</span>
<a name="ln-334"></a>   <span class="k">return</span>
<a name="ln-335"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">factorize_solver</span>
<a name="ln-336"></a>
<a name="ln-337"></a>
<a name="ln-338"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-339"></a>   <span class="c">!&gt; @note Subroutine to solve the system \([A]\{x\} = \{b\}\) (sparse A)</span>
<a name="ln-340"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-341"></a>   <span class="k">subroutine </span><span class="n">solution_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-342"></a>   <span class="k">implicit none</span>
<a name="ln-343"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">target</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-344"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ierr</span>
<a name="ln-345"></a>
<a name="ln-346"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-347"></a>
<a name="ln-348"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-349"></a>            <span class="k">call </span><span class="n">ma48_solve</span><span class="p">(</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-350"></a>                           <span class="n">factors</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fact</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-351"></a>                               <span class="n">rhs</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">,</span>              <span class="p">&amp;</span>
<a name="ln-352"></a>                                 <span class="n">x</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span><span class="p">,</span>              <span class="p">&amp;</span>
<a name="ln-353"></a>                           <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-354"></a>                             <span class="n">sinfo</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">sinf</span><span class="p">,</span>   <span class="p">&amp;</span>
<a name="ln-355"></a>                             <span class="n">resid</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">resid</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-356"></a>                             <span class="n">error</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">error</span><span class="p">)</span>
<a name="ln-357"></a>
<a name="ln-358"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-359"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">job</span> <span class="o">=</span> <span class="mi">3</span>
<a name="ln-360"></a>            <span class="k">call </span><span class="n">dmumps</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">)</span>
<a name="ln-361"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-362"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span><span class="s1">&#39;(a,a,i6,a,i9)&#39;</span><span class="p">)</span> <span class="s1">&#39; error return: &#39;</span><span class="p">,</span>                              <span class="p">&amp;</span>
<a name="ln-363"></a>                                          <span class="s1">&#39;  mumps_par%infog(1)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-364"></a>                                          <span class="s1">&#39;  mumps_par%infog(2)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-365"></a>               <span class="k">call </span><span class="n">mpi_finalize</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-366"></a>               <span class="k">stop</span> <span class="s1">&#39;Error in SOLUTION_SOLVER&#39;</span>
<a name="ln-367"></a>            <span class="n">endif</span>
<a name="ln-368"></a>            <span class="c">! solution has been assembled on the host</span>
<a name="ln-369"></a>            <span class="k">if</span> <span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-370"></a><span class="k">               </span><span class="n">mat</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">rhs</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mat</span><span class="p">%</span><span class="n">nn</span><span class="p">)</span>
<a name="ln-371"></a>            <span class="n">endif</span>
<a name="ln-372"></a>
<a name="ln-373"></a>         <span class="k">case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-374"></a>            <span class="k">call </span><span class="n">solv_superlu</span><span class="p">(</span><span class="n">sol_x</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span><span class="p">,</span>        <span class="p">&amp;</span>
<a name="ln-375"></a>                              <span class="n">sulu</span>  <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-376"></a>                           <span class="n">verbose</span>  <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="k">options</span><span class="p">%</span><span class="n">PrintStat</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-377"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">first</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-378"></a>
<a name="ln-379"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-380"></a>            <span class="c">! Numeric factors must exist</span>
<a name="ln-381"></a>            <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">C_ASSOCIATED</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">))</span> <span class="k">call </span><span class="n">solve_syst</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s1">&#39;fac&#39;</span><span class="p">)</span>
<a name="ln-382"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">(</span><span class="n">UMFPACK_IRSTEP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">! solve ax=b, without iterative refinement</span>
<a name="ln-383"></a>
<a name="ln-384"></a>            <span class="c">! If you want to evaluate the required RAM (Go)</span>
<a name="ln-385"></a>            <span class="c">! write(*,*) mat%matumfp%c_info(UMFPACK_PEAK_MEMORY_ESTIMATE)/mat%matumfp%c_info(UMFPACK_SIZE_OF_UNIT)/1e9</span>
<a name="ln-386"></a>            <span class="c">! write(*,*) sizeof(mat%a_elt)/1e9</span>
<a name="ln-387"></a>
<a name="ln-388"></a>            <span class="k">call </span><span class="n">s_umfpack_di_solve</span><span class="p">(</span><span class="n">sys</span> <span class="o">=</span> <span class="n">UMFPACK_A</span><span class="p">,</span>              <span class="p">&amp;</span>
<a name="ln-389"></a>                                      <span class="n">x</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span><span class="p">,</span>                  <span class="p">&amp;</span>
<a name="ln-390"></a>                                      <span class="n">b</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">,</span>                  <span class="p">&amp;</span>
<a name="ln-391"></a>                                <span class="n">numeric</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-392"></a>                                <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-393"></a>                                   <span class="n">info</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">)</span>
<a name="ln-394"></a>
<a name="ln-395"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">(</span><span class="n">UMFPACK_STATUS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-396"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;error occurred in umfpack_di_solve: &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">(</span><span class="n">UMFPACK_STATUS</span><span class="p">)</span>
<a name="ln-397"></a>               <span class="k">stop</span> <span class="s1">&#39;Error in SOLUTION_SOLVER&#39;</span>
<a name="ln-398"></a>            <span class="n">endif</span>
<a name="ln-399"></a>
<a name="ln-400"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-401"></a>            <span class="k">stop</span> <span class="s1">&#39;Unknown solver type, SOLUTION_SOLVER&#39;</span>
<a name="ln-402"></a>
<a name="ln-403"></a>      <span class="n">endselect</span>
<a name="ln-404"></a>
<a name="ln-405"></a>   <span class="k">return</span>
<a name="ln-406"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">solution_solver</span>
<a name="ln-407"></a>
<a name="ln-408"></a>
<a name="ln-409"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-410"></a>   <span class="c">!&gt; @note Subroutine to free the factors if applicable</span>
<a name="ln-411"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-412"></a>   <span class="k">subroutine </span><span class="n">freefact_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-413"></a>   <span class="k">implicit none</span>
<a name="ln-414"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-415"></a>
<a name="ln-416"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-417"></a>
<a name="ln-418"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-419"></a>            <span class="k">continue</span>
<a name="ln-420"></a><span class="k">            </span>
<a name="ln-421"></a><span class="k">         case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-422"></a>            <span class="k">continue</span>
<a name="ln-423"></a><span class="k">            </span>
<a name="ln-424"></a><span class="k">         case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-425"></a>            <span class="k">call </span><span class="n">free_superlu</span><span class="p">()</span>
<a name="ln-426"></a>
<a name="ln-427"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-428"></a>            <span class="k">call </span><span class="n">umfpack_di_free_numeric</span><span class="p">(</span><span class="n">Numeric</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">)</span> <span class="c">! free the numeric factorization</span>
<a name="ln-429"></a>
<a name="ln-430"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-431"></a>            <span class="k">stop</span> <span class="s1">&#39;unknown solver type, FREEFACT_SOLVER&#39;</span>
<a name="ln-432"></a>
<a name="ln-433"></a>      <span class="n">endselect</span>
<a name="ln-434"></a>
<a name="ln-435"></a>   <span class="k">return</span>
<a name="ln-436"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">freefact_solver</span>
<a name="ln-437"></a>
<a name="ln-438"></a>
<a name="ln-439"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-440"></a>   <span class="c">!&gt; @note Subroutine to close the solver</span>
<a name="ln-441"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-442"></a>   <span class="k">subroutine </span><span class="n">close_solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-443"></a>   <span class="k">implicit none</span>
<a name="ln-444"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-445"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ierr</span>
<a name="ln-446"></a>
<a name="ln-447"></a>      <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltptr</span> <span class="p">)</span>
<a name="ln-448"></a>      <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltvar</span> <span class="p">)</span>
<a name="ln-449"></a>
<a name="ln-450"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-451"></a>
<a name="ln-452"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>
<a name="ln-453"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">row</span> <span class="p">)</span>
<a name="ln-454"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">col</span> <span class="p">)</span>
<a name="ln-455"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">zmat</span><span class="p">%</span><span class="n">val</span> <span class="p">)</span>
<a name="ln-456"></a>            
<a name="ln-457"></a>            <span class="k">call </span><span class="n">ma48_finalize</span><span class="p">(</span><span class="n">factors</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">fact</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-458"></a>                               <span class="n">control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matma48</span><span class="p">%</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-459"></a>                               <span class="n">info</span>    <span class="o">=</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-460"></a>            <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span> <span class="p">)</span>
<a name="ln-461"></a>
<a name="ln-462"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>
<a name="ln-463"></a>            <span class="k">if</span> <span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span><span class="k">then</span>
<a name="ln-464"></a><span class="k">               nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">rhs</span>    <span class="p">)</span>
<a name="ln-465"></a>               <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">eltptr</span> <span class="p">)</span>
<a name="ln-466"></a>               <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">eltvar</span> <span class="p">)</span>
<a name="ln-467"></a>               <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">a_elt</span>  <span class="p">)</span>
<a name="ln-468"></a>            <span class="n">endif</span>
<a name="ln-469"></a>            
<a name="ln-470"></a>            <span class="c">! destroy the instance (deallocate internal data structures)</span>
<a name="ln-471"></a>            <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">job</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<a name="ln-472"></a>            <span class="k">call </span><span class="n">dmumps</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">)</span>
<a name="ln-473"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-474"></a><span class="k">               write</span><span class="p">(</span><span class="n">OPU</span><span class="p">,</span><span class="s1">&#39;(a,a,i6,a,i9)&#39;</span><span class="p">)</span> <span class="s1">&#39; error return: &#39;</span><span class="p">,</span>                              <span class="p">&amp;</span>
<a name="ln-475"></a>                                          <span class="s1">&#39;  mumps_par%infog(1)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-476"></a>                                          <span class="s1">&#39;  mumps_par%infog(2)= &#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">matmump</span><span class="p">%</span><span class="n">infog</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-477"></a>               <span class="k">call </span><span class="n">mpi_finalize</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-478"></a>               <span class="k">stop</span> <span class="s1">&#39;Error MUMP in close_solver&#39;</span>
<a name="ln-479"></a>            <span class="n">endif</span>
<a name="ln-480"></a>            <span class="k">call </span><span class="n">mpi_finalize</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-481"></a>            <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span> <span class="p">)</span>
<a name="ln-482"></a>
<a name="ln-483"></a>         <span class="k">case</span><span class="p">(</span><span class="n">SULU</span><span class="p">)</span>
<a name="ln-484"></a>            <span class="k">call </span><span class="n">close_superlu</span><span class="p">(</span><span class="n">sulu</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">)</span>
<a name="ln-485"></a>
<a name="ln-486"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">b</span>     <span class="p">)</span>
<a name="ln-487"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">irow</span>  <span class="p">)</span>
<a name="ln-488"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">jptr</span>  <span class="p">)</span>
<a name="ln-489"></a>            <span class="k">nullify</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">matsulu</span><span class="p">%</span><span class="n">a_elt</span> <span class="p">)</span>
<a name="ln-490"></a>
<a name="ln-491"></a>         <span class="k">case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">)</span>
<a name="ln-492"></a>            <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span> <span class="p">)</span>
<a name="ln-493"></a>
<a name="ln-494"></a>            <span class="k">call </span><span class="n">umfpack_di_free_numeric</span><span class="p">(</span><span class="n">Numeric</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_numeric</span><span class="p">)</span>     <span class="c">! free the numeric factorization</span>
<a name="ln-495"></a>            <span class="c">! no lu factors (numeric) are in memory at this point.</span>
<a name="ln-496"></a>            <span class="k">call </span><span class="n">umfpack_di_free_symbolic</span><span class="p">(</span><span class="n">Symbolic</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_symbolic</span><span class="p">)</span>  <span class="c">! free the symbolic analysis</span>
<a name="ln-497"></a>            <span class="k">call </span><span class="n">umfpack_di_report_info</span><span class="p">(</span><span class="n">Control</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_control</span><span class="p">,</span>      <span class="p">&amp;</span>
<a name="ln-498"></a>                                        <span class="n">Info</span>    <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">matumfp</span><span class="p">%</span><span class="n">c_info</span><span class="p">)</span>         <span class="c">! print final statistics</span>
<a name="ln-499"></a>            <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">x</span> <span class="p">)</span>
<a name="ln-500"></a>
<a name="ln-501"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-502"></a>            <span class="k">stop</span> <span class="s1">&#39;Unknown solver type, close_solver&#39;</span>
<a name="ln-503"></a>
<a name="ln-504"></a>      <span class="n">endselect</span>
<a name="ln-505"></a>
<a name="ln-506"></a>   <span class="k">return</span>
<a name="ln-507"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">close_solver</span>
<a name="ln-508"></a>
<a name="ln-509"></a>
<a name="ln-510"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-511"></a>   <span class="c">!&gt; @note Subroutine to transform the Rutherford Boeing format into Harwell Boeing and triplet</span>
<a name="ln-512"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-513"></a>   <span class="k">subroutine </span><span class="n">convert_matrice_format</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-514"></a>   <span class="k">implicit none</span>
<a name="ln-515"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-516"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>
<a name="ln-517"></a>
<a name="ln-518"></a>      <span class="c">! =======================================================================================================================</span>
<a name="ln-519"></a>      <span class="c">! Compressed Column Storage (CCS) is also called the Harwell-Boeing sparse matrix format.</span>
<a name="ln-520"></a>      <span class="c">! ************************************************</span>
<a name="ln-521"></a>      <span class="c">! Elemental entries (example provided by MUMP):</span>
<a name="ln-522"></a>      <span class="c">! A1 = 1|-1  2  3| A2 = 3|2 -1  3|</span>
<a name="ln-523"></a>      <span class="c">!      2| 2  1  1|      4|1  2 -1|</span>
<a name="ln-524"></a>      <span class="c">!      3| 1  1  1|      5|3  2  1| =&gt; a_elt = (-1, 2, 1, 2, 1, 1, 3, 1, 1, 2, 1, 3, -1, 2, 2, 3, -1, 1)</span>
<a name="ln-525"></a>      <span class="c">!</span>
<a name="ln-526"></a>      <span class="c">! A  = 1|-1  2  3  0  0|</span>
<a name="ln-527"></a>      <span class="c">!      2| 2  1  1  0  0|</span>
<a name="ln-528"></a>      <span class="c">!      3| 1  1  3 -1  3|</span>
<a name="ln-529"></a>      <span class="c">!      4| 0  0  1  2 -1|</span>
<a name="ln-530"></a>      <span class="c">!      5| 0  0  3  2  1| =&gt; eltvar = (1, 2, 3, 3, 4, 5), it locates the elemental matrix line in the assembled matrix</span>
<a name="ln-531"></a>      <span class="c">!                        =&gt; eltptr = (1, 4, 7), it gives the elemental matrix first entry position in eltvar (last</span>
<a name="ln-532"></a>      <span class="c">!                                               position being size(eltvar)+1)</span>
<a name="ln-533"></a>      <span class="c">!</span>
<a name="ln-534"></a>      <span class="c">! ************************************************</span>
<a name="ln-535"></a>      <span class="c">! Assembled matrix :</span>
<a name="ln-536"></a>      <span class="c">! A being the same, a_elt = (-1, 2, 1, 2, 1, 1, 3, 1, 3, 1, 3, -1, 2, 2, 3, -1, 1)</span>
<a name="ln-537"></a>      <span class="c">!                    irow = ( 1, 2, 3, 1, 2, 3, 1, 2, 3, 4, 5,  3, 4, 5, 3,  4, 5)</span>
<a name="ln-538"></a>      <span class="c">!                    jptr = (1, 4, 7, 12, 15, 18)</span>
<a name="ln-539"></a>      <span class="c">!</span>
<a name="ln-540"></a>      <span class="c">! =======================================================================================================================</span>
<a name="ln-541"></a>      <span class="c">! Triplet form</span>
<a name="ln-542"></a>      <span class="c">! ************************************************</span>
<a name="ln-543"></a>      <span class="c">! For each non zero a_elt entry, returns its row and column number</span>
<a name="ln-544"></a>      <span class="c">! A being the same, a_elt = (-1, 2, 1, 2, 1, 1, 3, 1, 3, 1, 3, -1, 2, 2, 3, -1, 1)</span>
<a name="ln-545"></a>      <span class="c">!                    irow = ( 1, 2, 3, 1, 2, 3, 1, 2, 3, 4, 5,  3, 4, 5, 3,  4, 5)</span>
<a name="ln-546"></a>      <span class="c">!                    jcol = ( 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 3,  4, 4, 4, 5,  5, 5)</span>
<a name="ln-547"></a>
<a name="ln-548"></a>      <span class="k">call </span><span class="n">from_elemental_to_assembled</span><span class="p">(</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">)</span>
<a name="ln-549"></a>
<a name="ln-550"></a>      <span class="k">select case</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span><span class="p">)</span>
<a name="ln-551"></a>
<a name="ln-552"></a>         <span class="k">case</span><span class="p">(</span><span class="n">MA48</span><span class="p">)</span>  <span class="c">! Triplet form: irow, jcol, a_elt</span>
<a name="ln-553"></a>            <span class="k">continue</span>
<a name="ln-554"></a>
<a name="ln-555"></a><span class="k">         case</span><span class="p">(</span><span class="n">MUMP</span><span class="p">)</span>  <span class="c">! Compressed row, elemental entries chosen: eltptr, eltvar, a_elt</span>
<a name="ln-556"></a>            <span class="k">continue</span>
<a name="ln-557"></a>
<a name="ln-558"></a><span class="k">         case</span><span class="p">(</span><span class="n">UMFP</span><span class="p">,</span> <span class="n">SULU</span><span class="p">)</span>  <span class="c">! Compressed row, assembled form: irow, jptr, a_elt</span>
<a name="ln-559"></a>            <span class="k">deallocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">jcol</span> <span class="p">)</span> <span class="c">! no more needed</span>
<a name="ln-560"></a>            <span class="c">! UMFP and SULU allocations begin at 0 (C convention)</span>
<a name="ln-561"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-562"></a>               <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-563"></a>            <span class="n">enddo</span>
<a name="ln-564"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mat</span><span class="p">%</span><span class="n">nz</span>
<a name="ln-565"></a>               <span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-566"></a>            <span class="n">enddo</span>
<a name="ln-567"></a>            
<a name="ln-568"></a>         <span class="k">case </span><span class="n">default</span>
<a name="ln-569"></a>            <span class="k">stop</span> <span class="s1">&#39;Unknown solver type, CONVERT_MATRICE_FORMAT&#39;</span>
<a name="ln-570"></a>
<a name="ln-571"></a>      <span class="n">endselect</span>
<a name="ln-572"></a>   <span class="k">return</span>
<a name="ln-573"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">convert_matrice_format</span>
<a name="ln-574"></a>
<a name="ln-575"></a>
<a name="ln-576"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-577"></a>   <span class="c">!&lt; @note Subroutine to sort an integer vector and a real vector (tabint, tabreal) according </span>
<a name="ln-578"></a>   <span class="c">!  tabref</span>
<a name="ln-579"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-580"></a>   <span class="k">recursive subroutine </span><span class="n">sort_entier_int_real</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabint</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-581"></a>   <span class="k">implicit none</span>
<a name="ln-582"></a><span class="k">   </span><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">g</span><span class="p">,</span> <span class="n">d</span>
<a name="ln-583"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tabref</span>
<a name="ln-584"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tabint</span>
<a name="ln-585"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span>    <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tabreal</span>
<a name="ln-586"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mil</span><span class="p">,</span> <span class="n">itmp</span>
<a name="ln-587"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">cle</span>
<a name="ln-588"></a>      <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">atmp</span>
<a name="ln-589"></a>      <span class="n">i</span> <span class="o">=</span> <span class="n">g</span>
<a name="ln-590"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">d</span>
<a name="ln-591"></a>      <span class="n">mil</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-592"></a>      <span class="n">cle</span> <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">mil</span><span class="p">)</span>
<a name="ln-593"></a>
<a name="ln-594"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">&gt;=</span><span class="n">d</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-595"></a>
<a name="ln-596"></a><span class="k">      do while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">j</span><span class="p">)</span>
<a name="ln-597"></a>         <span class="k">do while</span> <span class="p">(</span><span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&lt;</span><span class="n">cle</span><span class="p">)</span>
<a name="ln-598"></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-599"></a>         <span class="n">enddo</span>
<a name="ln-600"></a>         <span class="k">do while</span> <span class="p">(</span><span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&gt;</span><span class="n">cle</span><span class="p">)</span>
<a name="ln-601"></a>            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-602"></a>         <span class="n">enddo</span>
<a name="ln-603"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">j</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-604"></a>            <span class="c">! échange des éléments du tableau</span>
<a name="ln-605"></a>            <span class="n">tmp</span>       <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-606"></a>            <span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-607"></a>            <span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span>
<a name="ln-608"></a>            <span class="c">! échange des éléments du vecteur 2</span>
<a name="ln-609"></a>            <span class="n">itmp</span>      <span class="o">=</span> <span class="n">tabint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-610"></a>            <span class="n">tabint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tabint</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-611"></a>            <span class="n">tabint</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">itmp</span>
<a name="ln-612"></a>            <span class="c">! échange des éléments du vecteur 3</span>
<a name="ln-613"></a>            <span class="n">atmp</span>       <span class="o">=</span> <span class="n">tabreal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-614"></a>            <span class="n">tabreal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tabreal</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-615"></a>            <span class="n">tabreal</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">atmp</span>
<a name="ln-616"></a>
<a name="ln-617"></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-618"></a>            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-619"></a>         <span class="n">endif</span>
<a name="ln-620"></a>      <span class="n">enddo</span>
<a name="ln-621"></a>
<a name="ln-622"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">&lt;</span><span class="n">j</span><span class="p">)</span> <span class="k">call </span><span class="n">sort_entier_int_real</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabint</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-623"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">&gt;</span><span class="n">i</span><span class="p">)</span> <span class="k">call </span><span class="n">sort_entier_int_real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabint</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-624"></a>
<a name="ln-625"></a>   <span class="k">return</span>
<a name="ln-626"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">sort_entier_int_real</span>
<a name="ln-627"></a>
<a name="ln-628"></a>
<a name="ln-629"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-630"></a>   <span class="c">!&gt; @note Subroutine to sort a real vector (tabreal) according tabref</span>
<a name="ln-631"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-632"></a>   <span class="k">recursive subroutine </span><span class="n">sort_entier_real</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-633"></a>   <span class="k">implicit none</span>
<a name="ln-634"></a><span class="k">   </span><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">g</span><span class="p">,</span> <span class="n">d</span>
<a name="ln-635"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tabref</span>
<a name="ln-636"></a>   <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span>    <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tabreal</span>
<a name="ln-637"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mil</span>
<a name="ln-638"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">cle</span>
<a name="ln-639"></a>      <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">atmp</span>
<a name="ln-640"></a>      <span class="n">i</span> <span class="o">=</span> <span class="n">g</span>
<a name="ln-641"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">d</span>
<a name="ln-642"></a>      <span class="n">mil</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-643"></a>      <span class="n">cle</span> <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">mil</span><span class="p">)</span>
<a name="ln-644"></a>
<a name="ln-645"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">&gt;=</span><span class="n">d</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-646"></a>
<a name="ln-647"></a><span class="k">      do while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">j</span><span class="p">)</span>
<a name="ln-648"></a>         <span class="k">do while</span> <span class="p">(</span><span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&lt;</span><span class="n">cle</span><span class="p">)</span>
<a name="ln-649"></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-650"></a>         <span class="n">enddo</span>
<a name="ln-651"></a>         <span class="k">do while</span> <span class="p">(</span><span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&gt;</span><span class="n">cle</span><span class="p">)</span>
<a name="ln-652"></a>            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-653"></a>         <span class="n">enddo</span>
<a name="ln-654"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">j</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-655"></a>            <span class="c">! échange des éléments du tableau</span>
<a name="ln-656"></a>            <span class="n">tmp</span>       <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-657"></a>            <span class="n">tabref</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-658"></a>            <span class="n">tabref</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span>
<a name="ln-659"></a>            <span class="c">! échange des éléments du vecteur 2</span>
<a name="ln-660"></a>            <span class="n">atmp</span>       <span class="o">=</span> <span class="n">tabreal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-661"></a>            <span class="n">tabreal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tabreal</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-662"></a>            <span class="n">tabreal</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">atmp</span>
<a name="ln-663"></a>
<a name="ln-664"></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-665"></a>            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-666"></a>         <span class="n">endif</span>
<a name="ln-667"></a>      <span class="n">enddo</span>
<a name="ln-668"></a>
<a name="ln-669"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">&lt;</span><span class="n">j</span><span class="p">)</span> <span class="k">call </span><span class="n">sort_entier_real</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-670"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">&gt;</span><span class="n">i</span><span class="p">)</span> <span class="k">call </span><span class="n">sort_entier_real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tabref</span><span class="p">,</span> <span class="n">tabreal</span><span class="p">)</span>
<a name="ln-671"></a>
<a name="ln-672"></a>   <span class="k">return</span>
<a name="ln-673"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">sort_entier_real</span>
<a name="ln-674"></a>
<a name="ln-675"></a>
<a name="ln-676"></a>   <span class="c">!=========================================================================================</span>
<a name="ln-677"></a>   <span class="c">!&gt; @note Subroutine to transform the elemental entries into assembled CC vectors</span>
<a name="ln-678"></a>   <span class="c">!-----------------------------------------------------------------------------------------</span>
<a name="ln-679"></a>   <span class="k">subroutine </span><span class="n">from_elemental_to_assembled</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<a name="ln-680"></a>   <span class="k">implicit none</span>
<a name="ln-681"></a><span class="k">   type</span><span class="p">(</span><span class="n">MAT_SOLV</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">mat</span>   <span class="c">!! *high level system type*</span>
<a name="ln-682"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">solver</span><span class="p">,</span> <span class="n">nb_elt</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ntot</span><span class="p">,</span> <span class="n">nz</span>
<a name="ln-683"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">eltptr</span>
<a name="ln-684"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">eltvar</span>
<a name="ln-685"></a>      <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">R8</span><span class="p">),</span>    <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">a_elt</span>
<a name="ln-686"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">irow</span><span class="p">,</span> <span class="n">jcol</span>
<a name="ln-687"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">jptr</span>
<a name="ln-688"></a>      <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">I4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inelt</span><span class="p">,</span> <span class="n">imatorder</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ir1</span><span class="p">,</span> <span class="n">ir2</span><span class="p">,</span> <span class="n">jr1</span><span class="p">,</span> <span class="n">jr2</span><span class="p">,</span> <span class="n">itmp</span><span class="p">,</span> <span class="n">innz</span><span class="p">,</span> <span class="n">state</span>
<a name="ln-689"></a>
<a name="ln-690"></a>      <span class="n">solver</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">slv_t</span>
<a name="ln-691"></a>      <span class="n">nb_elt</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">ne</span>
<a name="ln-692"></a>      <span class="n">n</span>        <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">nn</span>
<a name="ln-693"></a>      <span class="n">ntot</span>     <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">nt</span>
<a name="ln-694"></a>      <span class="n">nz</span>       <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">nz</span>
<a name="ln-695"></a>      
<a name="ln-696"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">solver</span><span class="o">==</span><span class="n">MUMP</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-697"></a>
<a name="ln-698"></a>      <span class="c">! conversion from elemental form to triplet form, perhaps with null a_elts</span>
<a name="ln-699"></a>      <span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-700"></a>      <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-701"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span><span class="p">(</span><span class="n">ntot</span><span class="p">),</span> <span class="nb">stat</span> <span class="o">=</span> <span class="n">state</span> <span class="p">)</span>
<a name="ln-702"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">stop</span> <span class="s1">&#39;Memory allocation problem, FROM_ELEMENTAL_TO_ASSEMBLED&#39;</span>
<a name="ln-703"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">jcol</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">jcol</span><span class="p">(</span><span class="n">ntot</span><span class="p">),</span> <span class="nb">stat</span> <span class="o">=</span> <span class="n">state</span> <span class="p">)</span>
<a name="ln-704"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">stop</span> <span class="s1">&#39;Memory allocation problem, FROM_ELEMENTAL_TO_ASSEMBLED&#39;</span>
<a name="ln-705"></a>
<a name="ln-706"></a>      <span class="n">eltptr</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltptr</span>
<a name="ln-707"></a>      <span class="n">eltvar</span>   <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">eltvar</span>
<a name="ln-708"></a>      <span class="n">a_elt</span>    <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">a_elt</span>
<a name="ln-709"></a>      <span class="n">irow</span>     <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">irow</span>
<a name="ln-710"></a>      <span class="n">jcol</span>     <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">jcol</span>
<a name="ln-711"></a>      <span class="n">jptr</span>     <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span>
<a name="ln-712"></a>
<a name="ln-713"></a>      <span class="n">irow</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-714"></a>      <span class="n">jcol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-715"></a>      
<a name="ln-716"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-717"></a>      <span class="k">do </span><span class="n">inelt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb_elt</span>
<a name="ln-718"></a>         <span class="n">imatorder</span> <span class="o">=</span> <span class="n">eltptr</span><span class="p">(</span><span class="n">inelt</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="n">eltptr</span><span class="p">(</span><span class="n">inelt</span><span class="p">)</span>
<a name="ln-719"></a>         <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imatorder</span>
<a name="ln-720"></a>            <span class="n">irow</span><span class="p">(</span><span class="n">ii</span><span class="p">:(</span><span class="n">ii</span> <span class="o">+</span><span class="n">imatorder</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">eltvar</span><span class="p">(</span><span class="n">eltptr</span><span class="p">(</span><span class="n">inelt</span><span class="p">):</span><span class="n">eltptr</span><span class="p">(</span><span class="n">inelt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-721"></a>            <span class="n">jcol</span><span class="p">(</span><span class="n">ii</span><span class="p">:(</span><span class="n">ii</span> <span class="o">+</span><span class="n">imatorder</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">eltvar</span><span class="p">(</span><span class="n">eltptr</span><span class="p">(</span><span class="n">inelt</span><span class="p">)</span> <span class="o">+</span><span class="n">i</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-722"></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span><span class="n">imatorder</span>
<a name="ln-723"></a>         <span class="n">enddo</span>
<a name="ln-724"></a>      <span class="n">enddo</span>
<a name="ln-725"></a>
<a name="ln-726"></a>      <span class="c">! where a_elt brings no contribution, rows and columns are zeroed</span>
<a name="ln-727"></a>      <span class="c">!-----------------------------------------------------------------</span>
<a name="ln-728"></a>      <span class="k">where</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a_elt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EPS_R8</span> <span class="p">)</span>
<a name="ln-729"></a>         <span class="n">irow</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-730"></a>         <span class="n">jcol</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-731"></a>      <span class="n">endwhere</span>
<a name="ln-732"></a>
<a name="ln-733"></a>      <span class="c">! the triplet irow, jcol and a_elt is sorted according jcol</span>
<a name="ln-734"></a>      <span class="c">!-----------------------------------------------------------</span>
<a name="ln-735"></a>      <span class="k">call </span><span class="n">sort_entier_int_real</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">ntot</span><span class="p">,</span> <span class="n">tabref</span><span class="o">=</span><span class="n">jcol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">),</span> <span class="n">tabint</span><span class="o">=</span><span class="n">irow</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">),</span> <span class="n">tabreal</span><span class="o">=</span><span class="n">a_elt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">))</span>
<a name="ln-736"></a>
<a name="ln-737"></a>
<a name="ln-738"></a>      <span class="c">! column pointer determination for each new value</span>
<a name="ln-739"></a>      <span class="c">!----------------------------------------------</span>
<a name="ln-740"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">)</span> <span class="p">;</span> <span class="k">allocate</span><span class="p">(</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span> <span class="n">jptr</span> <span class="o">=&gt;</span> <span class="n">mat</span><span class="p">%</span><span class="n">jptr</span>
<a name="ln-741"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-742"></a>      <span class="k">do</span>
<a name="ln-743"></a><span class="k">         if</span> <span class="p">(</span><span class="n">jcol</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">exit</span>  <span class="c">! zeroed terms are ignored</span>
<a name="ln-744"></a>         <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-745"></a>      <span class="n">enddo</span>
<a name="ln-746"></a>      <span class="n">jptr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ii</span>
<a name="ln-747"></a>
<a name="ln-748"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-749"></a>         <span class="n">itmp</span> <span class="o">=</span> <span class="n">jcol</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
<a name="ln-750"></a>         <span class="k">do</span>
<a name="ln-751"></a><span class="k">            </span><span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-752"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">jcol</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">/=</span> <span class="n">itmp</span><span class="p">)</span> <span class="k">exit</span>
<a name="ln-753"></a><span class="k">         </span><span class="n">enddo</span>
<a name="ln-754"></a>         <span class="n">jptr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ii</span>
<a name="ln-755"></a>      <span class="n">enddo</span>
<a name="ln-756"></a>      <span class="n">jptr</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntot</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-757"></a>
<a name="ln-758"></a>      <span class="c">! columns are already sorted; rows are now sorted for each row value</span>
<a name="ln-759"></a>      <span class="c">!--------------------------------------------------------------------</span>
<a name="ln-760"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-761"></a>         <span class="n">i1</span> <span class="o">=</span> <span class="n">jptr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-762"></a>         <span class="n">i2</span> <span class="o">=</span> <span class="n">jptr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-763"></a>         <span class="k">call </span><span class="n">sort_entier_real</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">i2</span> <span class="o">-</span><span class="n">i1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tabref</span><span class="o">=</span><span class="n">irow</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">),</span> <span class="n">tabreal</span><span class="o">=</span><span class="n">a_elt</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">))</span>
<a name="ln-764"></a>      <span class="n">enddo</span>
<a name="ln-765"></a>
<a name="ln-766"></a>      <span class="c">! assembly starting from the jcol, irow and a_elt top</span>
<a name="ln-767"></a>      <span class="c">! for identical matrix locations, a_elts are added</span>
<a name="ln-768"></a>      <span class="c">!-----------------------------------------------------</span>
<a name="ln-769"></a>      <span class="n">innz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-770"></a>      <span class="n">jj</span>  <span class="o">=</span> <span class="n">jptr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c">! first non-zero element</span>
<a name="ln-771"></a>      <span class="n">jr1</span> <span class="o">=</span> <span class="n">jcol</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-772"></a>      <span class="n">ir1</span> <span class="o">=</span> <span class="n">irow</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-773"></a>      <span class="n">jcol</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span>  <span class="o">=</span> <span class="n">jr1</span>
<a name="ln-774"></a>      <span class="n">irow</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ir1</span>
<a name="ln-775"></a>      <span class="n">a_elt</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">=</span> <span class="n">a_elt</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-776"></a>
<a name="ln-777"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntot</span>
<a name="ln-778"></a>         <span class="n">jr2</span> <span class="o">=</span> <span class="n">jcol</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-779"></a>         <span class="n">ir2</span> <span class="o">=</span> <span class="n">irow</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-780"></a>         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">jr2</span> <span class="o">/=</span> <span class="n">jr1</span><span class="p">).</span><span class="nb">or</span><span class="p">.(</span><span class="n">ir2</span> <span class="o">/=</span> <span class="n">ir1</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>  <span class="c">! if row or column index has changed</span>
<a name="ln-781"></a>            <span class="n">innz</span> <span class="o">=</span> <span class="n">innz</span> <span class="o">+</span><span class="mi">1</span>                         <span class="c">! a non-zero term is added</span>
<a name="ln-782"></a>            <span class="n">jcol</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">=</span> <span class="n">jr2</span>
<a name="ln-783"></a>            <span class="n">irow</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">=</span> <span class="n">ir2</span>
<a name="ln-784"></a>            <span class="n">a_elt</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">=</span> <span class="n">a_elt</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-785"></a>         <span class="k">else</span>
<a name="ln-786"></a><span class="k">            </span><span class="n">a_elt</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">=</span> <span class="n">a_elt</span><span class="p">(</span><span class="n">innz</span><span class="p">)</span> <span class="o">+</span> <span class="n">a_elt</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>   <span class="c">! row and column indexes are the same, stiffness terms are added</span>
<a name="ln-787"></a>         <span class="n">endif</span>
<a name="ln-788"></a>         <span class="n">jr1</span> <span class="o">=</span> <span class="n">jr2</span>                                 <span class="c">! stores (i-1) and (j-1) for further comparison</span>
<a name="ln-789"></a>         <span class="n">ir1</span> <span class="o">=</span> <span class="n">ir2</span>
<a name="ln-790"></a>      <span class="n">enddo</span>
<a name="ln-791"></a>      <span class="n">nz</span> <span class="o">=</span> <span class="n">innz</span>
<a name="ln-792"></a>      <span class="n">jcol</span><span class="p">(</span> <span class="n">nz</span> <span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-793"></a>      <span class="n">irow</span><span class="p">(</span> <span class="n">nz</span> <span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-794"></a>      <span class="n">a_elt</span><span class="p">(</span><span class="n">nz</span> <span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ntot</span><span class="p">)</span> <span class="o">=</span> <span class="nb">huge</span><span class="p">(</span><span class="mf">1._R8</span><span class="p">)</span>
<a name="ln-795"></a>
<a name="ln-796"></a>      <span class="c">! col pointer update</span>
<a name="ln-797"></a>      <span class="c">!----------------------------------------------</span>
<a name="ln-798"></a>      <span class="n">jj</span>      <span class="o">=</span> <span class="mi">1</span>
<a name="ln-799"></a>      <span class="n">jptr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-800"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-801"></a>         <span class="n">itmp</span> <span class="o">=</span> <span class="n">jcol</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-802"></a>         <span class="k">do</span>
<a name="ln-803"></a><span class="k">            </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-804"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">jcol</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">/=</span> <span class="n">itmp</span><span class="p">)</span> <span class="k">exit</span>
<a name="ln-805"></a><span class="k">         </span><span class="n">enddo</span>
<a name="ln-806"></a>         <span class="n">jptr</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">jj</span>
<a name="ln-807"></a>      <span class="n">enddo</span>
<a name="ln-808"></a>      <span class="n">jptr</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nz</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-809"></a>   <span class="k">return</span>
<a name="ln-810"></a><span class="k">   </span><span class="n">endsubroutine</span> <span class="n">from_elemental_to_assembled</span>
<a name="ln-811"></a>
<a name="ln-812"></a><span class="n">endmodule</span> <span class="n">solver</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2018-07-20 11:50  
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> MSOLV-fortran was developed by Arthur Francisco - Noël Brunetière</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>